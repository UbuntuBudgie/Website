---
import { getCollection, getEntry } from "astro:content";
import type { CollectionEntry } from "astro:content";
import BlogLayout from "../../layouts/BlogLayout.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
  // Ensure this matches the collection name in src/content/config.ts
  const posts = await getCollection("blog"); 
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props as { post: CollectionEntry<"blog"> };
const { Content } = await post.render();

// 1. Sanitize the author name to create a predictable slug.
//    (e.g., "Jane Doe" -> "jane-doe")
const authorName = post.data.author.trim();
const authorSlug = authorName.toLowerCase().replace(/\s+/g, '-');

// 2. Prioritize fetching from the 'team' collection.
let author = await getEntry('authors', authorSlug);

// 3. Fallback/Strict Check: If the team member wasn't found, check the 'authors' collection 
//    (useful if your config has both, or if you prefer 'authors').
if (!author) {
    author = await getEntry('authors', authorSlug);
}

// 4. Throw an error if the author is still missing from both collections.
if (!author) {
  throw new Error(`[${post.slug}] Author/Team member not found for slug: "${authorSlug}" (derived from "${authorName}"). Please check 'author' frontmatter against 'src/content/team/' or 'src/content/authors/' filenames.`);
}

// The 'author' variable now holds the CollectionEntry from either 'team' or 'authors'.
---
<BaseLayout title={post.data.title} description={post.data.description}>
  <div class="mx-auto max-w-7xl py-12 px-4 sm:px-6 lg:px-8">
    <BlogLayout post={post} author={author}>
      <Content />
    </BlogLayout>
  </div>
</BaseLayout>