---
import { getCollection, getEntry } from "astro:content";
import PostCard from "../../components/PostCard.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";

const POSTS_PER_PAGE = 5;

const allPosts = (await getCollection("blog")).sort(
  (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime()
);

const postsWithAuthors = await Promise.all(
  allPosts.map(async (post) => {
    // 1. Get the author string from the blog post
    // 2. Convert "John Doe" -> "john-doe" to match the filename created by Pages CMS
    const authorSlug = post.data.author.trim().toLowerCase().replace(/\s+/g, '-');
    
    // 3. Fetch from the 'team' collection instead of 'authors'
    const author = await getEntry('authors', authorSlug);

    if (!author) {
      // Helpful error message for debugging
      throw new Error(`[Blog Index] Team member not found for slug: "${authorSlug}" (derived from "${post.data.author}"). Check src/content/team/`);
    }
    return { post, author };
  })
);

const totalPages = Math.ceil(postsWithAuthors.length / POSTS_PER_PAGE);
const paginatedPosts = postsWithAuthors.slice(0, POSTS_PER_PAGE);
---

<BaseLayout title="Our Blog" description="Latest news and updates.">
  {/* Your HTML remains the same */}
  <section class="py-16 sm:py-24">
    <div class="mx-auto max-w-7xl px-6 lg:px-8">
      <div class="mx-auto grid max-w-2xl grid-cols-1 gap-x-8 gap-y-12 lg:mx-0 lg:max-w-none lg:grid-cols-2">
        {paginatedPosts.map(({ post, author }) => (
          <PostCard post={post} author={author} />
        ))}
      </div>
       {/* ... Pagination code ... */}
    </div>
  </section>
</BaseLayout>