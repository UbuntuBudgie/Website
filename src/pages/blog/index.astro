---
import { getCollection, getEntry } from "astro:content";
import PostCard from "../../components/PostCard.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";

const POSTS_PER_PAGE = 5;

const allPosts = (await getCollection("blog")).sort(
  (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime()
);

// This is the strict logic. If any author slug in any post is invalid,
// this line will throw a clear error in your terminal and stop the build.
const postsWithAuthors = await Promise.all(
  allPosts.map(async (post) => {
    const cleanedSlug = post.data.author.trim().toLowerCase();
    const author = await getEntry('authors', cleanedSlug);
    // Add a check here to provide a better error message
    if (!author) {
      throw new Error(`[Blog Index] Author not found for slug: "${cleanedSlug}" in post "${post.slug}".`);
    }
    return { post, author };
  })
);

const totalPages = Math.ceil(postsWithAuthors.length / POSTS_PER_PAGE);
const paginatedPosts = postsWithAuthors.slice(0, POSTS_PER_PAGE);
---

<BaseLayout title="Our Blog" description="Latest news and updates from the team.">
  <section class="py-16 sm:py-24">
    <div class="mx-auto max-w-7xl px-6 lg:px-8">
      <div class="mx-auto grid max-w-2xl grid-cols-1 gap-x-8 gap-y-12 lg:mx-0 lg:max-w-none lg:grid-cols-2">
        {paginatedPosts.map(({ post, author }) => (
          <PostCard post={post} author={author} />
        ))}
      </div>
      <nav class="mt-16 flex justify-center gap-4">
        {totalPages > 1 && (
          <a href="/blog/page/2/"
             class="inline-block rounded-lg border border-gray-300 bg-white px-6 py-2 font-semibold text-gray-800 shadow-sm transition-colors hover:bg-gray-100">
            Next â†’
          </a>
        )}
      </nav>
    </div>
  </section>
</BaseLayout>